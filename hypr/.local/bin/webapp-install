#!/bin/bash
# Simple webapp installer - creates a .desktop file for a website as an app

APP_NAME="$1"
APP_URL="$2"
ICON_URL="$3"

if [[ -z "$APP_NAME" || -z "$APP_URL" ]]; then
    echo "Usage: webapp-install <name> <url> [icon-url]"
    echo "Example: webapp-install YouTube https://youtube.com https://example.com/icon.png"
    exit 1
fi

ICON_DIR="$HOME/.local/share/icons/webapps"
DESKTOP_DIR="$HOME/.local/share/applications"
mkdir -p "$ICON_DIR" "$DESKTOP_DIR"

# Download icon if URL provided
if [[ -n "$ICON_URL" ]]; then
    ICON_PATH="$ICON_DIR/$APP_NAME.png"
    curl -sL -o "$ICON_PATH" "$ICON_URL"

    # Validate it's actually an image
    if ! file "$ICON_PATH" | grep -qE "image|PNG|JPEG|icon"; then
        echo "Warning: Downloaded file is not an image, trying favicon..."
        # Try to get favicon from the domain
        DOMAIN=$(echo "$APP_URL" | sed -E 's|https?://([^/]+).*|\1|')
        curl -sL -o "$ICON_PATH" "https://www.google.com/s2/favicons?domain=$DOMAIN&sz=128"

        if ! file "$ICON_PATH" | grep -qE "image|PNG|JPEG|icon"; then
            echo "Warning: Could not get valid icon, using default"
            ICON_PATH="chromium"
        fi
    fi
else
    # No icon provided, try to get high-res favicon
    DOMAIN=$(echo "$APP_URL" | sed -E 's|https?://([^/]+).*|\1|')
    ICON_PATH="$ICON_DIR/$APP_NAME.png"

    # Try DuckDuckGo icons (usually higher quality)
    curl -sL -o "$ICON_PATH" "https://icons.duckduckgo.com/ip3/$DOMAIN.ico"

    if ! file "$ICON_PATH" | grep -qE "image|PNG|JPEG|icon|ICO"; then
        # Fallback to Google
        curl -sL -o "$ICON_PATH" "https://www.google.com/s2/favicons?domain=$DOMAIN&sz=256"
    fi

    if ! file "$ICON_PATH" | grep -qE "image|PNG|JPEG|icon|ICO"; then
        ICON_PATH="chromium"
    fi
fi

echo "Icon: $ICON_PATH"

# Create .desktop file
cat > "$DESKTOP_DIR/$APP_NAME.desktop" << EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=$APP_NAME Web App
Exec=chromium --app=$APP_URL
Terminal=false
Type=Application
Icon=$ICON_PATH
StartupNotify=true
Categories=Network;WebApp;
EOF

chmod +x "$DESKTOP_DIR/$APP_NAME.desktop"
echo "Created webapp: $APP_NAME"
echo "Launch it from rofi (SUPER+D)"
